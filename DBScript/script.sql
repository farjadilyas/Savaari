/*
FIND_STATUS: DEFAULT : 0, NOT_FOUND : 1, FOUND : 2
*/
CREATE TABLE `ride_hailing`.`RIDER_DETAILS` 
(
     `USER_ID` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,
     `USER_NAME` VARCHAR(32) NOT NULL,
     `EMAIL_ADDRESS` VARCHAR(255) UNIQUE NOT NULL,
     `PASSWORD` VARCHAR(255) NOT NULL,
     `LATITUDE` DECIMAL(9,6) NULL DEFAULT 0,
     `LONGITUDE` DECIMAL(9,6) NULL DEFAULT 0,
     `TIMESTAMP` TIMESTAMP NULL DEFAULT NULL,
     `FIND_STATUS` INT(1) DEFAULT 0,
     `DRIVER_ID` INT(10) DEFAULT -1,
     PRIMARY KEY (`USER_ID`), 
     INDEX `USER_AUTH`(`EMAIL_ADDRESS`, `PASSWORD`)
) ENGINE = InnoDB;


/*
     IS_ACTIVE: INACTIVE : 0, ACTIVE : 1
     RIDE_STATUS: NOT_ASSIGNED : 0, REQ_RECEIVED: 1, ACCEPTED: 2, CANCELLED: 3, COMPLETED: 4
     TODO: ADD FOREIGN KEY CONSTRAINT (USER_ID, ACTIVE_VEHICLE_ID) REFERENCES DRIVERS_VEHICLES(DRIVER_ID, VEHICLE_ID)
*/
CREATE TABLE `ride_hailing`.`DRIVER_DETAILS` 
(
     `USER_ID` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,
     `USER_NAME` VARCHAR(32) NOT NULL,
     `EMAIL_ADDRESS` VARCHAR(255) UNIQUE NOT NULL,
     `PASSWORD` VARCHAR(255) NOT NULL,
     `LATITUDE` DECIMAL(9,6) NULL DEFAULT 0,
     `LONGITUDE` DECIMAL(9,6) NULL DEFAULT 0,
     `TIMESTAMP` TIMESTAMP NULL DEFAULT NULL,
     `IS_ACTIVE` BOOLEAN DEFAULT FALSE,
     `RIDE_STATUS` INT(1) DEFAULT 0,
     `RIDER_ID` INT(10) DEFAULT -1,
     `SOURCE_LAT` DECIMAL(9,6) NULL DEFAULT 0,
     `SOURCE_LONG` DECIMAL(9,6) NULL DEFAULT 0,
     `DEST_LAT` DECIMAL(9,6) NULL DEFAULT 0,
     `DEST_LONG` DECIMAL(9,6) NULL DEFAULT 0,
     `ACTIVE_VEHICLE_ID` INT(3) UNSIGNED,
     PRIMARY KEY (`USER_ID`),
     INDEX `USER_AUTH`(`EMAIL_ADDRESS`, `PASSWORD`)
) ENGINE = InnoDB;


CREATE TABLE `ride_hailing`.`RIDE_TYPES`
(
     `TYPE_ID` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,
     `NAME` VARCHAR(32) UNIQUE NOT NULL,
     `MULTIPLIER` DECIMAL(3,2) UNSIGNED NOT NULL,
     `MAX_PASSENGERS` INT(2) UNSIGNED NOT NULL,
     STATUS BOOLEAN DEFAULT FALSE,
     PRIMARY KEY (`TYPE_ID`)
) ENGINE = InnoDB;




CREATE TABLE `ride_hailing`.`VEHICLE_TYPES`
(
     `VEHICLE_TYPE_ID` INT(10) UNSIGNED NOT NULL,
     `MAKE` VARCHAR(16),
     `MODEL` VARCHAR(32),
     `YEAR` CHAR(4),
     `RIDE_TYPE_ID` INT(10) UNSIGNED NOT NULL,
     PRIMARY KEY (`VEHICLE_TYPE_ID`),
     FOREIGN KEY (`RIDE_TYPE_ID`) REFERENCES `RIDE_TYPES`(`TYPE_ID`),
     UNIQUE(`MAKE`, `MODEL`, `YEAR`)
) ENGINE = InnoDB;

CREATE TABLE `ride_hailing`.`DRIVERS_VEHICLES`
(
     `DRIVER_ID` INT(10) UNSIGNED NOT NULL,
     `VEHICLE_ID` INT(3) UNSIGNED NOT NULL,
     `VEHICLE_TYPE_ID` INT(10) UNSIGNED NOT NULL,
     `NUMBER_PLATE` CHAR(8) NOT NULL,
     `COLOR` VARCHAR(32),
     PRIMARY KEY (`DRIVER_ID`, `VEHICLE_ID`),
     FOREIGN KEY (`VEHICLE_TYPE_ID`) REFERENCES `VEHICLE_TYPES`(`VEHICLE_TYPE_ID`)
) ENGINE = InnoDB;

DELIMITER $$
CREATE OR REPLACE TRIGGER DV_ON_INSERT
    BEFORE INSERT ON DRIVERS_VEHICLES
    FOR EACH ROW
BEGIN
    DECLARE MAX_VEHICLE_ID INT;
    SET MAX_VEHICLE_ID = 1;
    SET MAX_VEHICLE_ID = (SELECT NVL(MAX(VEHICLE_ID),0)
    FROM DRIVERS_VEHICLES
    GROUP BY DRIVER_ID
    HAVING DRIVER_ID = NEW.DRIVER_ID);
    
    SET NEW.VEHICLE_ID = MAX_VEHICLE_ID + 1;
END$$

CREATE TABLE `ride_hailing`.`PAYMENTS`
(
     `PAYMENT_ID` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,
     `AMOUNT_PAID` DECIMAL(8,2),
     `CHANGE` DECIMAL(8,2),
     `TIMESTAMP` TIMESTAMP NULL DEFAULT NULL,
     `PAYMENT_MODE` INT(1),
     PRIMARY KEY (`PAYMENT_ID`)
) ENGINE = InnoDB;


CREATE TABLE `ride_hailing`.`RIDES`
(
     `RIDE_ID` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,
     `RIDER_ID` INT(10) UNSIGNED NOT NULL,
     `DRIVER_ID` INT(10) UNSIGNED NOT NULL,
     `PAYMENT_ID` INT(10) UNSIGNED UNIQUE,
     `SOURCE_LAT` DECIMAL(9,6) NULL DEFAULT 0,
     `SOURCE_LONG` DECIMAL(9,6) NULL DEFAULT 0,
     `DEST_LAT` DECIMAL(9,6) NULL DEFAULT 0,
     `DEST_LONG` DECIMAL(9,6) NULL DEFAULT 0,
     `START_TIME` TIMESTAMP NULL DEFAULT NULL,
     `FINISH_TIME` TIMESTAMP NULL DEFAULT NULL,
     `DIST_TRAVELLED` DECIMAL(7, 3) DEFAULT 0,
     `RIDE_TYPE` INT(10) UNSIGNED NOT NULL,
     `ESTIMATED_FARE` INT(4) UNSIGNED,
     `FARE` DECIMAL(8,2) UNSIGNED,
     `STATUS` INT(1) UNSIGNED DEFAULT 0,
     PRIMARY KEY (`RIDE_ID`),
     FOREIGN KEY (`RIDER_ID`) REFERENCES `RIDER_DETAILS`(`USER_ID`),
     FOREIGN KEY (`DRIVER_ID`) REFERENCES `DRIVER_DETAILS`(`USER_ID`),
     FOREIGN KEY (`PAYMENT_ID`) REFERENCES `PAYMENTS`(`PAYMENT_ID`),
     FOREIGN KEY (`RIDE_TYPE`) REFERENCES `RIDE_TYPES`(`TYPE_ID`),
     INDEX `RIDER_RIDES`(`RIDER_ID`),
     INDEX `DRIVER_RIDES`(`DRIVER_ID`)
) ENGINE = InnoDB;

DROP TABLE `RIDES`;
DROP TABLE `PAYMENTS`;
DROP TABLE `DRIVERS_VEHICLES`;
DROP TABLE `VEHICLE_TYPES`;
DROP TABLE `RIDE_TYPES`;
DROP TABLE `DRIVER_DETAILS`;
DROP TABLE `RIDER_DETAILS`;



/* Initialize tables with necessary data */

INSERT INTO RIDE_TYPES(TYPE_ID, NAME, MULTIPLIER, MAX_PASSENGERS)
VALUES(0, "Bike", 1, 1),(0, "Small", 1.2, 4), (0, "Med", 1.4, 8), (0, "NotSoSmol", 2, 6);




/*RESET ALL DRIVERS*/
UPDATE DRIVER_DETAILS
SET IS_ACTIVE = 0, RIDE_STATUS = 0, RIDER_ID = -1, SOURCE_LAT = 0, SOURCE_LONG = 0, DEST_LAT = 0, DEST_LONG = 0;

UPDATE RIDER_DETAILS
SET FIND_STATUS = 0, DRIVER_ID = -1;

DELETE FROM RIDES;

DELETE FROM PAYMENTS;